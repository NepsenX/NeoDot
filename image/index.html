<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width; height=device-height;">
  <link rel="stylesheet" href="resource://content-accessible/ImageDocument.css">
  <title></title>
    <style>  
        .loading {
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            text-align: center;
        }
        
        .shrinkToFit {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            display: none; /* Hidden until loaded */
        }
        
        canvas {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading"></div>
    <img class="shrinkToFit" id="generatedImage">
    <canvas id="processedCanvas"></canvas>

    <script>
        // =============================================
        // CONFIGURATION DICTIONARIES
        // =============================================
        
        // Model configurations with tokens and settings
        const MODEL_CONFIG = {
            'nanobanana': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'seedream': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'flux': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'proteus': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'realvisxl': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'dreamshaper': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'majicmix': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'absolute': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'lyriel': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'rc': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'sd': { token: 'vHigSh5nPMrSeQbx', requiresToken: true },
            'turbo': { token: null, requiresToken: false },
            'flex': { token: null, requiresToken: false },
            'playground': { token: null, requiresToken: false },
            'openjourney': { token: null, requiresToken: false }
        };

        // API Endpoints and URLs
        const API_CONFIG = {
            promptEnhancement: 'https://corsproxy.io/?url=https://text.pollinations.ai/write_only_prompt_for_the_user_image',
            imageGeneration: 'https://corsproxy.io/?url=https://image.pollinations.ai/prompt',
            enhancementModel: 'openai', // Changed from 'openai-fast'
            defaultModel: 'nanobanana',
            fallbackModels: ['seedream', 'flex']
        };

        // Watermark removal settings
        const WATERMARK_CONFIG = {
            removeFilter: '&nofilter=1',
            cropRightPercentage: 0.05,
            cropBottomPercentage: 0.05,
            extraBottomCrop: 12,
            maxCropPixels: 100,
            watermarkDetectionArea: 20,
            watermarkPixelThreshold: 100,
            watermarkColorThreshold: { r: 220, g: 220, b: 220, a: 100 }
        };

        // Logo configuration
        const LOGO_CONFIG = {
            svg: `
                <svg width="60" height="24" viewBox="0 0 60 24" xmlns="http://www.w3.org/2000/svg">
                    <text x="0" y="18" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white">NeoDot</text>
                    <circle cx="48" cy="12" r="3" fill="white"/>
                </svg>
            `,
            maxWidthPercentage: 0.08,
            maxWidthPixels: 60,
            margin: 8,
            backgroundOpacity: 0.4,
            backgroundPadding: 4
        };

        // Size presets dictionary (200+ presets)
        const sizePresets = { // <-- Corrected capitalization
            // Social Media
            youtube: { width: 1280, height: 720 },
            youtube_thumbnail: { width: 1280, height: 720 },
            youtube_channel: { width: 2560, height: 423 },
            youtube_banner: { width: 2560, height: 1440 },
            facebook: { width: 1200, height: 630 },
            facebook_cover: { width: 820, height: 312 },
            facebook_profile: { width: 170, height: 170 },
            facebook_story: { width: 1080, height: 1920 },
            instagram: { width: 1080, height: 1080 },
            instagram_story: { width: 1080, height: 1920 },
            instagram_reel: { width: 1080, height: 1920 },
            instagram_profile: { width: 320, height: 320 },
            twitter: { width: 1200, height: 675 },
            twitter_header: { width: 1500, height: 500 },
            twitter_profile: { width: 400, height: 400 },
            linkedin: { width: 1200, height: 627 },
            linkedin_cover: { width: 1128, height: 191 },
            linkedin_profile: { width: 400, height: 400 },
            linkedin_company: { width: 300, height: 300 },
            pinterest: { width: 1000, height: 1500 },
            pinterest_profile: { width: 165, height: 165 },
            tiktok: { width: 1080, height: 1920 },
            tiktok_profile: { width: 200, height: 200 },
            whatsapp: { width: 300, height: 300 },
            whatsapp_status: { width: 1080, height: 1920 },
            snapchat: { width: 1080, height: 1920 },
            snapchat_spotlight: { width: 1080, height: 1920 },
            discord: { width: 512, height: 512 },
            discord_banner: { width: 600, height: 240 },
            reddit: { width: 1200, height: 628 },
            reddit_banner: { width: 1920, height: 384 },
            reddit_profile: { width: 256, height: 256 },
            twitch: { width: 1280, height: 720 },
            twitch_banner: { width: 1200, height: 480 },
            twitch_profile: { width: 300, height: 300 },
            twitch_offline: { width: 1920, height: 1080 },
        
            // E-commerce
            amazon_product: { width: 1000, height: 1000 },
            amazon_main: { width: 1000, height: 1000 },
            amazon_gallery: { width: 500, height: 500 },
            ebay: { width: 1600, height: 1600 },
            shopify: { width: 2048, height: 2048 },
            shopify_collection: { width: 447, height: 447 },
            etsy: { width: 270, height: 270 },
            etsy_main: { width: 2000, height: 2000 },
            walmart: { width: 1000, height: 1000 },
            alibaba: { width: 1000, height: 1000 },
            aliexpress: { width: 1000, height: 1000 },
        
            // Advertising & Banners
            banner_728x90: { width: 728, height: 90 },
            banner_970x90: { width: 970, height: 90 },
            banner_970x250: { width: 970, height: 250 },
            banner_300x250: { width: 300, height: 250 },
            banner_300x600: { width: 300, height: 600 },
            banner_160x600: { width: 160, height: 600 },
            banner_320x50: { width: 320, height: 50 },
            banner_468x60: { width: 468, height: 60 },
            banner_120x600: { width: 120, height: 600 },
            banner_250x250: { width: 250, height: 250 },
            banner_120x240: { width: 120, height: 240 },
            banner_234x60: { width: 234, height: 60 },
            banner_125x125: { width: 125, height: 125 },
            banner_180x150: { width: 180, height: 150 },
            banner_240x400: { width: 240, height: 400 },
            banner_336x280: { width: 336, height: 280 },
            banner_580x400: { width: 580, height: 400 },
            billboard: { width: 2000, height: 1000 },
            digital_billboard: { width: 1440, height: 480 },
        
            // Mobile Devices
            iphone_14: { width: 1170, height: 2532 },
            iphone_13: { width: 1170, height: 2532 },
            iphone_12: { width: 1170, height: 2532 },
            iphone_11: { width: 828, height: 1792 },
            iphone_se: { width: 750, height: 1334 },
            iphone_x: { width: 1125, height: 2436 },
            iphone_8: { width: 750, height: 1334 },
            samsung_galaxy_s23: { width: 1080, height: 2340 },
            samsung_galaxy_s22: { width: 1080, height: 2340 },
            samsung_galaxy_s21: { width: 1080, height: 2400 },
            google_pixel_7: { width: 1080, height: 2400 },
            google_pixel_6: { width: 1080, height: 2400 },
            oneplus_9: { width: 1080, height: 2400 },
            xiaomi_mi_11: { width: 1440, height: 3200 },
            huawei_p50: { width: 1228, height: 2700 },
        
            // Tablets
            ipad_pro: { width: 2048, height: 2732 },
            ipad_air: { width: 1640, height: 2360 },
            ipad_mini: { width: 1488, height: 2266 },
            samsung_tab_s8: { width: 1600, height: 2560 },
            microsoft_surface: { width: 1440, height: 2160 },
            amazon_fire_hd: { width: 800, height: 1280 },
            google_pixel_tablet: { width: 1600, height: 2560 },
        
            // Desktop & Laptops
            desktop_1080p: { width: 1920, height: 1080 },
            desktop_1440p: { width: 2560, height: 1440 },
            desktop_4k: { width: 3840, height: 2160 },
            desktop_8k: { width: 7680, height: 4320 },
            laptop_13: { width: 1440, height: 900 },
            laptop_14: { width: 1920, height: 1080 },
            laptop_15: { width: 1920, height: 1080 },
            laptop_17: { width: 1920, height: 1080 },
            macbook_pro_13: { width: 2560, height: 1600 },
            macbook_pro_14: { width: 3024, height: 1964 },
            macbook_pro_16: { width: 3456, height: 2234 },
            imac_24: { width: 4480, height: 2520 },
            imac_27: { width: 5120, height: 2880 },
        
            // Photography
            photo_2x3: { width: 1000, height: 1500 },
            photo_3x4: { width: 750, height: 1000 },
            photo_4x6: { width: 1000, height: 1500 },
            photo_5x7: { width: 1000, height: 1400 },
            photo_8x10: { width: 1000, height: 1250 },
            photo_11x14: { width: 1100, height: 1400 },
            photo_16x20: { width: 1600, height: 2000 },
            photo_20x24: { width: 2000, height: 2400 },
            photo_24x36: { width: 2400, height: 3600 },
        
            // Print Sizes
            print_a0: { width: 2384, height: 3370 },
            print_a1: { width: 1684, height: 2384 },
            print_a2: { width: 1191, height: 1684 },
            print_a3: { width: 842, height: 1191 },
            print_a4: { width: 595, height: 842 },
            print_a5: { width: 420, height: 595 },
            print_a6: { width: 298, height: 420 },
            print_a7: { width: 210, height: 298 },
            print_a8: { width: 147, height: 210 },
            print_letter: { width: 612, height: 792 },
            print_legal: { width: 612, height: 1008 },
            print_tabloid: { width: 792, height: 1224 },
            print_business_card: { width: 300, height: 150 },
        
            // Website Elements
            website_header: { width: 1920, height: 400 },
            website_hero: { width: 1920, height: 800 },
            website_banner: { width: 1920, height: 600 },
            website_slider: { width: 1920, height: 800 },
            website_sidebar: { width: 300, height: 250 },
            website_footer: { width: 1920, height: 400 },
            website_background: { width: 1920, height: 1080 },
            website_logo: { width: 200, height: 100 },
            website_favicon: { width: 32, height: 32 },
            website_icon: { width: 64, height: 64 },
        
            // App Store & Google Play
            appstore_iphone_65: { width: 1284, height: 2778 },
            appstore_iphone_55: { width: 1242, height: 2208 },
            appstore_iphone_47: { width: 750, height: 1334 },
            appstore_ipad: { width: 2048, height: 2732 },
            appstore_watch: { width: 368, height: 448 },
            googleplay_feature: { width: 1024, height: 500 },
            googleplay_phone: { width: 512, height: 512 },
            googleplay_tablet: { width: 1024, height: 500 },
            googleplay_wear: { width: 512, height: 512 },
            googleplay_tv: { width: 1280, height: 720 },
        
            // Email Marketing
            email_header: { width: 600, height: 200 },
            email_banner: { width: 600, height: 300 },
            email_product: { width: 300, height: 300 },
            email_newsletter: { width: 600, height: 400 },
            email_signature: { width: 300, height: 100 },
            email_sidebar: { width: 150, height: 150 },
        
            // Gaming
            steam_header: { width: 460, height: 215 },
            steam_main: { width: 616, height: 353 },
            steam_small: { width: 231, height: 87 },
            steam_hero: { width: 1920, height: 620 },
            epic_games: { width: 2560, height: 1440 },
            xbox_game: { width: 1920, height: 1080 },
            playstation_game: { width: 1920, height: 1080 },
            nintendo_switch: { width: 1280, height: 720 },
            twitch_stream: { width: 1920, height: 1080 },
            discord_stream: { width: 1920, height: 1080 },
        
            // Video & Streaming
            video_480p: { width: 854, height: 480 },
            video_720p: { width: 1280, height: 720 },
            video_1080p: { width: 1920, height: 1080 },
            video_1440p: { width: 2560, height: 1440 },
            video_4k: { width: 3840, height: 2160 },
            video_8k: { width: 7680, height: 4320 },
            video_instagram: { width: 1080, height: 1920 },
            video_tiktok: { width: 1080, height: 1920 },
            video_square: { width: 1080, height: 1080 },
            video_portrait: { width: 1080, height: 1920 },
            video_landscape: { width: 1920, height: 1080 },
        
            // Presentations
            powerpoint_4x3: { width: 1024, height: 768 },
            powerpoint_16x9: { width: 1920, height: 1080 },
            powerpoint_16x10: { width: 1920, height: 1200 },
            keynote_slide: { width: 1920, height: 1080 },
            google_slides: { width: 1920, height: 1080 },
            presentation_cover: { width: 1920, height: 1080 },
            presentation_slide: { width: 1920, height: 1080 },
        
            // Documents
            document_a4: { width: 595, height: 842 },
            document_letter: { width: 612, height: 792 },
            document_legal: { width: 612, height: 1008 },
            document_cover: { width: 1200, height: 800 },
            document_brochure: { width: 850, height: 1100 },
            document_flyer: { width: 850, height: 1100 },
            document_poster: { width: 2400, height: 3600 },
        
            // Icons & Logos
            icon_16: { width: 16, height: 16 },
            icon_32: { width: 32, height: 32 },
            icon_48: { width: 48, height: 48 },
            icon_64: { width: 64, height: 64 },
            icon_128: { width: 128, height: 128 },
            icon_256: { width: 256, height: 256 },
            icon_512: { width: 512, height: 512 },
            logo_small: { width: 100, height: 50 },
            logo_medium: { width: 200, height: 100 },
            logo_large: { width: 400, height: 200 },
            logo_square: { width: 200, height: 200 },
            logo_wide: { width: 300, height: 100 },
        
            // Miscellaneous
            square_100: { width: 100, height: 100 },
            square_200: { width: 200, height: 200 },
            square_300: { width: 300, height: 300 },
            square_400: { width: 400, height: 400 },
            square_500: { width: 500, height: 500 },
            square_600: { width: 600, height: 600 },
            square_700: { width: 700, height: 700 },
            square_800: { width: 800, height: 800 },
            square_900: { width: 900, height: 900 },
            square_1000: { width: 1000, height: 1000 },
            portrait_300x400: { width: 300, height: 400 },
            portrait_400x600: { width: 400, height: 600 },
            portrait_600x900: { width: 600, height: 900 },
            portrait_800x1200: { width: 800, height: 1200 },
            landscape_400x300: { width: 400, height: 300 },
            landscape_600x400: { width: 600, height: 400 },
            landscape_800x600: { width: 800, height: 600 },
            landscape_1200x800: { width: 1200, height: 800 },
            default: { width: 800, height: 600 }
        };
                

        // =============================================
        // MAIN APPLICATION CODE
        // =============================================

        // Helper function to process size parameter
        function getSizeDimensions(sizeParam) {
            let width = sizePresets.default.width;
            let height = sizePresets.default.height;

            if (!sizeParam) {
                return { width, height };
            }

            const lowerCaseSize = sizeParam.toLowerCase();

            // 1. Check if it's a known preset name
            if (sizePresets[lowerCaseSize]) {
                width = sizePresets[lowerCaseSize].width;
                height = sizePresets[lowerCaseSize].height;
            } 
            // 2. Check if it's in WxH format
            else if (lowerCaseSize.includes('x')) {
                const parts = lowerCaseSize.split('x').map(p => parseInt(p, 10));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    width = parts[0];
                    height = parts[1];
                }
            }
            // 3. Check if it's a single number (for square output)
            else if (!isNaN(sizeParam)) {
                width = parseInt(sizeParam, 10);
                height = parseInt(sizeParam, 10);
            }
            
            // Limit sizes to max 2000x2000 for stability unless it's a preset
            if (width > 2000 && !sizePresets[lowerCaseSize]) width = 2000;
            if (height > 2000 && !sizePresets[lowerCaseSize]) height = 2000;

            return { width, height };
        }


        document.addEventListener('DOMContentLoaded', async function() {
            const img = document.getElementById('generatedImage');
            const canvas = document.getElementById('processedCanvas');
            const loading = document.getElementById('loading');
            const ctx = canvas.getContext('2d');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const text = urlParams.get('text');
            const model = urlParams.get('model');
            const size = urlParams.get('size');
            const userUrl = urlParams.get('url');
            const seed = urlParams.get('seed');
            
            if (!text) {
                loading.textContent = 'Error: No text prompt provided';
                return;
            }
            
            // Set page title to prompt
            document.title = text;
            
            // Generate random seed if not provided (1 to 999999)
            const finalSeed = seed || Math.floor(Math.random() * 999999) + 1;

            // Determine size dimensions for URL
            const { width: finalWidth, height: finalHeight } = getSizeDimensions(size);

            
            async function addLogoToCanvas() {
                return new Promise((resolve) => {
                    const logoImg = new Image();
                    const svgBlob = new Blob([LOGO_CONFIG.svg], { type: 'image/svg+xml' });
                    const logoUrl = URL.createObjectURL(svgBlob);
                    
                    logoImg.onload = function() {
                        // Small logo size - bottom right corner
                        const logoWidth = Math.min(canvas.width * LOGO_CONFIG.maxWidthPercentage, LOGO_CONFIG.maxWidthPixels);
                        const logoHeight = (logoWidth * 24) / 60; // Maintain aspect ratio
                        
                        const x = canvas.width - logoWidth - LOGO_CONFIG.margin;
                        const y = canvas.height - logoHeight - LOGO_CONFIG.margin;
                        
                        // Add semi-transparent background for better visibility
                        ctx.fillStyle = `rgba(0, 0, 0, ${LOGO_CONFIG.backgroundOpacity})`;
                        ctx.fillRect(
                            x - LOGO_CONFIG.backgroundPadding, 
                            y - LOGO_CONFIG.backgroundPadding, 
                            logoWidth + (LOGO_CONFIG.backgroundPadding * 2), 
                            logoHeight + (LOGO_CONFIG.backgroundPadding * 2)
                        );
                        
                        // Draw the logo
                        ctx.drawImage(logoImg, x, y, logoWidth, logoHeight);
                        
                        URL.revokeObjectURL(logoUrl);
                        resolve();
                    };
                    
                    logoImg.onerror = function() {
                        // If logo fails to load, just continue without it
                        console.log("Logo failed to load, continuing without logo");
                        resolve();
                    };
                    
                    logoImg.src = logoUrl;
                });
            }

            let finalPrompt = text;
            
            try {
                // Step 1: Always get enhanced prompt from OpenAI
                loading.textContent = 'Enhancing prompt with OpenAI...';
                const openaiPromptUrl = `${API_CONFIG.promptEnhancement}:${encodeURIComponent(text)}?model=${API_CONFIG.enhancementModel}`;
                
                try {
                    const promptResponse = await fetch(openaiPromptUrl);
                    if (promptResponse.ok) {
                        finalPrompt = await promptResponse.text();
                        console.log("Prompt enhanced successfully.");
                    } else {
                        console.warn("OpenAI prompt enhancement failed, status:", promptResponse.status, "Using original prompt.");
                    }
                } catch (promptError) {
                    console.error("Network or fetch error during prompt enhancement:", promptError);
                    // Continue with original prompt if enhancement fails
                }
                
                // Step 2: Build image URL based on the three main scenarios
                let imageUrl;
                loading.textContent = 'Generating image...';
                
                // Helper function to build the base URL part
                const buildBaseImageUrl = (selectedModel) => {
                    const config = MODEL_CONFIG[selectedModel] || MODEL_CONFIG[API_CONFIG.defaultModel];
                    let url = `${API_CONFIG.imageGeneration}/${encodeURIComponent(finalPrompt)}?model=${selectedModel}&seed=${finalSeed}&enhance=true`;
                    if (config.requiresToken) {
                        url += `&token=${config.token}`;
                    }
                    url += `${WATERMARK_CONFIG.removeFilter}&width=${finalWidth}&height=${finalHeight}`;
                    return url;
                };


                if (userUrl) {
                    // Scenario 1: Image-to-Image (requires tokenized model)
                    const modelConfig = MODEL_CONFIG[API_CONFIG.defaultModel];
                    imageUrl = `${API_CONFIG.imageGeneration}/${encodeURIComponent(finalPrompt)}?model=${API_CONFIG.defaultModel}&url=${encodeURIComponent(userUrl)}&seed=${finalSeed}&enhance=true&token=${modelConfig.token}${WATERMARK_CONFIG.removeFilter}&width=${finalWidth}&height=${finalHeight}`;
                    console.log("Using Image-to-Image generation.");
                }
                else if (model) {
                    // Scenario 2: Specific Model requested
                    const selectedModel = model.toLowerCase();
                    imageUrl = buildBaseImageUrl(selectedModel);
                    console.log(`Using specific model: ${selectedModel}`);
                }
                else {
                    // Scenario 3: Default/Fallback sequence
                    
                    // Try default model first
                    const defaultModel = API_CONFIG.defaultModel;
                    imageUrl = buildBaseImageUrl(defaultModel);
                
                    try {
                        console.log(`Attempting default model: ${defaultModel}`);
                        const res = await fetch(imageUrl, { method: "HEAD" });
                        if (!res.ok) {
                            console.warn(`Default model ${defaultModel} failed. Status: ${res.status}. Trying fallback models.`);
                            
                            // If default fails, try fallback models
                            for (const fallbackModel of API_CONFIG.fallbackModels) {
                                imageUrl = buildBaseImageUrl(fallbackModel);
                                console.log(`Attempting fallback model: ${fallbackModel}`);
                                const res2 = await fetch(imageUrl, { method: "HEAD" });
                                if (res2.ok) {
                                    console.log(`Fallback successful with ${fallbackModel}.`);
                                    break;
                                }
                            }
                        }
                    } catch (err) {
                        console.error("Network error during initial HEAD check, falling back to flex:", err);
                        // In case of network error, fallback directly to flex
                        imageUrl = buildBaseImageUrl('flex');
                    }
                }

                
                // Step 3: Load and process image for watermark removal
                loading.textContent = 'Processing image and removing watermark...';
                
                const response = await fetch(imageUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load image from Pollinations (HTTP Status: ${response.status})`);
                }
                
                const blob = await response.blob();
                const originalImageUrl = URL.createObjectURL(blob);
                
                const tempImg = new Image();
                tempImg.src = originalImageUrl;
                
                tempImg.onload = async function() {
                    // Calculate crop for watermark removal
                    const cropRight = Math.min(tempImg.width * WATERMARK_CONFIG.cropRightPercentage, WATERMARK_CONFIG.maxCropPixels);
                    const cropBottom = Math.min(tempImg.height * WATERMARK_CONFIG.cropBottomPercentage, WATERMARK_CONFIG.maxCropPixels) + WATERMARK_CONFIG.extraBottomCrop;
                    
                    canvas.width = tempImg.width - cropRight;
                    canvas.height = tempImg.height - cropBottom;
                    
                    // Draw original image (cropped)
                    ctx.drawImage(
                        tempImg, 
                        0, 0, 
                        canvas.width, canvas.height,
                        0, 0,
                        canvas.width, canvas.height
                    );
                    
                    // Enhanced watermark removal check
                    try {
                        const watermarkCheckArea = ctx.getImageData(
                            canvas.width - WATERMARK_CONFIG.watermarkDetectionArea,
                            canvas.height - WATERMARK_CONFIG.watermarkDetectionArea,
                            WATERMARK_CONFIG.watermarkDetectionArea,
                            WATERMARK_CONFIG.watermarkDetectionArea
                        );
                        
                        let watermarkPixels = 0;
                        const data = watermarkCheckArea.data;
                        const threshold = WATERMARK_CONFIG.watermarkColorThreshold;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            if (data[i] > threshold.r && data[i+1] > threshold.g && data[i+2] > threshold.b && data[i+3] > threshold.a) {
                                watermarkPixels++;
                            }
                        }
                        
                        if (watermarkPixels > WATERMARK_CONFIG.watermarkPixelThreshold) {
                            // Cut additional 1px if highly suspected
                            canvas.height -= 1;
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(
                                tempImg, 
                                0, 0, 
                                canvas.width, canvas.height,
                                0, 0,
                                canvas.width, canvas.height
                            );
                        }
                    } catch (e) {
                        console.warn("Watermark detection error, proceeding with current crop:", e);
                    }
                    
                    // Add NeoDot logo
                    loading.textContent = 'Adding NeoDot logo...';
                    await addLogoToCanvas();
                    
                    // Convert canvas to image and display
                    const processedImageUrl = canvas.toDataURL('image/png');
                    img.src = processedImageUrl;
                    
                    img.onload = function() {
                        // Hide loading, show image
                        loading.style.display = 'none';
                        img.style.display = 'block';
                        
                        // Set actual image dimensions
                        img.width = this.naturalWidth;
                        img.height = this.naturalHeight;
                        
                        // Clean up
                        URL.revokeObjectURL(originalImageUrl);
                        console.log("Image successfully processed and displayed.");
                    };
                };
                
                tempImg.onerror = function() {
                    loading.textContent = 'Error processing image: Image data invalid or corrupt.';
                    URL.revokeObjectURL(originalImageUrl);
                };
                
            } catch (error) {
                console.error('Main generation error:', error);
                loading.textContent = 'Error: ' + error.message + '. Attempting ultimate fallback...';
                
                // Ultimate fallback - try without enhancement or processing (using flex model)
                try {
                    const fallbackDimensions = getSizeDimensions(size); // Re-calculate dimensions for ultimate fallback
                    const finalUrl = `${API_CONFIG.imageGeneration}/${encodeURIComponent(text)}?model=flex&seed=${finalSeed}${WATERMARK_CONFIG.removeFilter}&width=${fallbackDimensions.width}&height=${fallbackDimensions.height}`;
                    
                    img.onload = function() {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                        img.width = this.naturalWidth;
                        img.height = this.naturalHeight;
                        console.log("Ultimate fallback succeeded.");
                    };
                    img.onerror = function() {
                        loading.textContent = 'Failed to load image after all attempts';
                    };
                    img.src = finalUrl;
                } catch (finalError) {
                    loading.textContent = 'All image generation methods failed';
                    console.error('Ultimate fallback failed:', finalError);
                }
            }
        });
    </script>
</body>
</html>
