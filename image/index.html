<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
<style>
    body {
        background-color: #000;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: Arial, sans-serif;
    }
</style>
</head>
<body>
    <img id="generatedImage" alt="Generated Image">

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const img = document.getElementById('generatedImage');
            
            // Get all URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const text = urlParams.get('text');
            const model = urlParams.get('model');
            const size = urlParams.get('size');
            const userUrl = urlParams.get('url');
            const seedParam = urlParams.get('seed');
            
            // Set the final seed
            const finalSeed = seedParam ? seedParam : Math.floor(Math.random() * 999999) + 1;
            
            // Validate that a text prompt exists
            if (!text) {
                document.title = "Error: No prompt provided";
                return;
            }
            document.title = text;
            
            try {
                // Step 1: Get enhanced prompt from OpenAI
                const openaiPromptUrl = `https://text.pollinations.ai/write_only_prompt_for_the_user_image:${encodeURIComponent(text)}?model=openai-fast`;
                const promptResponse = await fetch(openaiPromptUrl);
                const enhancedPrompt = await promptResponse.text();
                
                // Step 2: Determine the correct Pollinations.ai URL based on the parameters
                let imageUrl;
                const token = "vHigSh5nPMrSeQbx"; // Your token for specific models

                // SCENARIO 1: If a URL is provided, use the 'kontext' model
                if (userUrl) {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?model=kontext&url=${encodeURIComponent(userUrl)}&seed=${finalSeed}&enhance=true&token=${token}`;
                }
                // SCENARIO 2: If a model is specified
                else if (model) {
                    // Check if the model requires the token
                    if (model === 'seedream' || model === 'kontext') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?model=${model}&seed=${finalSeed}&enhance=true&token=${token}`;
                    } else {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?model=${model}&seed=${finalSeed}&enhance=true`;
                    }
                }
                // SCENARIO 3: Default case (only text)
                else {
                    // First, try with seedream and the token
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?model=seedream&enhance=true&seed=${finalSeed}&token=${token}`;
                }
                
                // Add size parameter if provided
                if (size) {
                    imageUrl += `&width=${size}`;
                }
                
                // Step 3: Try to load the image
                img.src = imageUrl;
                
                // Step 4: Fallback logic for the default (text-only) scenario
                img.onerror = async function() {
                    // Only attempt fallback if we are in the default scenario (no url, no model)
                    if (!userUrl && !model) {
                        let fallbackUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?model=flex&seed=${finalSeed}&enhance=true`;
                        if (size) {
                            fallbackUrl += `&width=${size}`;
                        }
                        img.src = fallbackUrl;
                    }
                };
                
            } catch (error) {
                // Ultimate fallback: use the original prompt directly with a basic setup
                let finalUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?model=flex&seed=${finalSeed}`;
                if (size) finalUrl += `&width=${size}`;
                img.src = finalUrl;
            }
        });
    </script>
</body>
</html>
