<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width; height=device-height;">
    <link rel="stylesheet" href="resource://content-accessible/ImageDocument.css">
    <link rel="stylesheet" href="resource://content-accessible/TopLevelImageDocument.css">
    <title></title>
</head>
<body>
    <img id="generatedImage" alt="Generated Image">

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const img = document.getElementById('generatedImage');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const text = urlParams.get('text');
            const model = urlParams.get('model');
            const size = urlParams.get('size');
            const userUrl = urlParams.get('url');
            const seed = urlParams.get('seed');
            
            if (!text) {
                console.error('No text prompt provided');
                return;
            }
            
            // Set page title to prompt
            document.title = text;
            
            // Generate random seed if not provided (1 to 999999)
            const finalSeed = seed || Math.floor(Math.random() * 999999) + 1;
            
            try {
                // Step 1: Always get enhanced prompt from OpenAI for all categories
                const openaiPromptUrl = `https://text.pollinations.ai/write_only_prompt_for_the_user_image:${encodeURIComponent(text)}?model=openai-fast`;
                const promptResponse = await fetch(openaiPromptUrl);
                
                if (!promptResponse.ok) {
                    throw new Error('OpenAI prompt enhancement failed');
                }
                
                const enhancedPrompt = await promptResponse.text();
                const finalPrompt = enhancedPrompt || text; // Fallback to original text if enhanced is empty
                
                // Step 2: Build image URL based on the three main scenarios
                let imageUrl;
                const token = "vHigSh5nPMrSeQbx";
                
                // SCENARIO 1: If URL provided → use kontext model with token
                if (userUrl) {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=kontext&url=${encodeURIComponent(userUrl)}&seed=${finalSeed}&enhance=true&token=${token}`;
                }
                // SCENARIO 2: If model specified → use specified model
                else if (model) {
                    // For seedream/kontext models, use token
                    if (model === 'seedream' || model === 'kontext') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=${model}&seed=${finalSeed}&enhance=true&token=${token}`;
                    } else {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=${model}&seed=${finalSeed}&enhance=true`;
                    }
                }
                // SCENARIO 3: Text only (default) → try seedream first with token
                else {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=seedream&seed=${finalSeed}&enhance=true&token=${token}`;
                }
                
                // Add size parameter if provided
                if (size) {
                    imageUrl += `&width=${size}`;
                }
                
                // Step 3: Set image source
                img.src = imageUrl;
                
                // Step 4: Fallback logic for default scenario
                img.onerror = async function() {
                    // Only fallback for default scenario (no url, no model)
                    if (!userUrl && !model) {
                        try {
                            const fallbackUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=flex&seed=${finalSeed}&enhance=true${size ? `&width=${size}` : ''}`;
                            img.src = fallbackUrl;
                        } catch (fallbackError) {
                            // Ultimate fallback: use original prompt without enhancement
                            const ultimateUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?model=flex&seed=${finalSeed}${size ? `&width=${size}` : ''}`;
                            img.src = ultimateUrl;
                        }
                    }
                };
                
            } catch (error) {
                console.error('Error in image generation:', error);
                // Ultimate fallback: use original prompt directly
                const finalUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?model=flex&seed=${finalSeed}${size ? `&width=${size}` : ''}`;
                img.src = finalUrl;
            }
        });
    </script>
</body>
</html>
