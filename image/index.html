<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>  
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .loading {
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            text-align: center;
        }
        
        .shrinkToFit {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading image...</div>
    <img class="shrinkToFit" id="generatedImage" alt="Generated Image">

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const img = document.getElementById('generatedImage');
            const loading = document.getElementById('loading');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const text = urlParams.get('text');
            const model = urlParams.get('model');
            const size = urlParams.get('size');
            const userUrl = urlParams.get('url');
            const seed = urlParams.get('seed');
            
            if (!text) {
                loading.textContent = 'Error: No text prompt provided';
                return;
            }
            
            // Set page title to prompt
            document.title = text;
            
            // Generate random seed if not provided (1 to 999999)
            const finalSeed = seed || Math.floor(Math.random() * 999999) + 1;
            
            try {
                // Step 1: Always get enhanced prompt from OpenAI for all categories
                const openaiPromptUrl = `https://text.pollinations.ai/write_only_prompt_for_the_user_image:${encodeURIComponent(text)}?model=openai-fast`;
                const promptResponse = await fetch(openaiPromptUrl);
                
                if (!promptResponse.ok) {
                    throw new Error('OpenAI prompt enhancement failed');
                }
                
                const enhancedPrompt = await promptResponse.text();
                const finalPrompt = enhancedPrompt || text;
                
                // Step 2: Build image URL based on the three main scenarios
                let imageUrl;
                const token = "vHigSh5nPMrSeQbx";
                
                if (userUrl) {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=kontext&url=${encodeURIComponent(userUrl)}&seed=${finalSeed}&enhance=true&token=${token}`;
                }
                else if (model) {
                    if (model === 'seedream' || model === 'kontext') {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=${model}&seed=${finalSeed}&enhance=true&token=${token}`;
                    } else {
                        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=${model}&seed=${finalSeed}&enhance=true`;
                    }
                }
                else {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=seedream&seed=${finalSeed}&enhance=true&token=${token}`;
                }
                
                // Add size parameter if provided
                if (size) {
                    imageUrl += `&width=${size}`;
                }
                
                // Set image source and handle loading
                img.onload = function() {
                    // Hide loading, show image
                    loading.style.display = 'none';
                    img.style.display = 'block';
                    
                    // Set image to fill available space while maintaining aspect ratio
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100vw';
                    img.style.maxHeight = '100vh';
                };
                
                img.onerror = async function() {
                    // Fallback for default scenario
                    if (!userUrl && !model) {
                        try {
                            const fallbackUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}?model=flex&seed=${finalSeed}&enhance=true${size ? `&width=${size}` : ''}`;
                            // Remove current onerror to prevent infinite loop
                            img.onerror = null;
                            img.src = fallbackUrl;
                        } catch (fallbackError) {
                            loading.textContent = 'Error loading image';
                        }
                    } else {
                        loading.textContent = 'Error loading image';
                    }
                };
                
                // Start loading the image
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Error in image generation:', error);
                // Ultimate fallback
                const finalUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?model=flex&seed=${finalSeed}${size ? `&width=${size}` : ''}`;
                img.onload = function() {
                    loading.style.display = 'none';
                    img.style.display = 'block';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100vw';
                    img.style.maxHeight = '100vh';
                };
                img.src = finalUrl;
            }
        });
    </script>
</body>
</html>
